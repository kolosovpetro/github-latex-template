name: 'Build LaTeX'
on:
  workflow_call:
    inputs:
      file_name:
        description: 'LaTeX root file name without extension, example: MyTeXFile'
        required: true
        type: string

      runs_on:
        description: 'Agent image'
        required: true
        type: string

      workflow_name:
        description: 'Workflow name'
        required: true
        type: string

      build_assets_path:
        description: 'Build assets path'
        required: true
        type: string

      working_directory_for_latex:
        description: 'Working directory for LaTeX'
        required: true
        type: string

      enable_patch_version:
        description: 'Enable to patch version.tex file'
        required: true
        default: true
        type: boolean

      enable_pandoc:
        description: 'Enable pandoc build for HTML'
        required: false
        default: false
        type: boolean

jobs:
  build-pdf:
    runs-on: ${{ inputs.runs_on }}
    name: ${{ inputs.workflow_name }}

    steps:
      - name: 'ğŸ” Fetch sources ğŸ”'
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: 'â¬‡ï¸ Install pandoc â¬‡ï¸'
        if: ${{ inputs.enable_pandoc }}
        uses: pandoc/actions/setup@v1

      - name: 'ğŸ”„ Run pandoc ğŸ”„'
        if: ${{ inputs.enable_pandoc }}
        run: pandoc --version

      - name: 'â¬‡ï¸ Install GitVersion â¬‡ï¸'
        if: ${{ inputs.enable_patch_version }}
        uses: gittools/actions/gitversion/setup@v4.2.0
        with:
          versionSpec: '6.x'
          preferLatestVersion: true

      - name: 'ğŸ¤” Determine Version ğŸ¤”'
        if: ${{ inputs.enable_patch_version }}
        uses: gittools/actions/gitversion/execute@v4.2.0
        with:
          configFilePath: GitVersion.yml

      - name: 'ğŸ“œ Print Version ğŸ“œ'
        if: ${{ inputs.enable_patch_version }}
        run: |
          echo "SemVer: ${{ env.GitVersion_SemVer }}"
          echo "BranchName: ${{ env.GitVersion_BranchName }}"
          echo "ShortSha: ${{ env.GitVersion_ShortSha }}"
          newVersion="${{ env.GitVersion_SemVer }}+${{ env.GitVersion_BranchName }}.${{ env.GitVersion_ShortSha }}"
          echo "Next version: $newVersion"

      - name: 'ğŸ”„ Update version.tex ğŸ”„'
        if: ${{ inputs.enable_patch_version }}
        shell: bash
        run: |
          rm -f "src/metadata/version.tex"
          newVersion="${{ env.GitVersion_SemVer }}+${{ env.GitVersion_BranchName }}.${{ env.GitVersion_ShortSha }}"
          echo "New version: $newVersion"
          echo "\texttt{$newVersion}" > "src/metadata/version.tex"
          echo "Contents of the file: src/metadata/version.tex"
          cat "src/metadata/version.tex"
          
      - name: 'ğŸ›  Build PDF ğŸ› '
        uses: xu-cheng/latex-action@v4
        with:
          root_file: '${{ inputs.file_name }}.tex'
          working_directory: '${{ inputs.working_directory_for_latex }}'

      - name: 'ğŸ›  Build Pandoc ğŸ› '
        if: ${{ inputs.enable_pandoc }}
        run: ./src/Generate-Html.ps1
        shell: pwsh

      - name: 'â¬†ï¸ Upload build assets â¬†ï¸'
        uses: actions/upload-artifact@v6
        with:
          name: 'build-assets'
          path: '${{ inputs.build_assets_path }}'

      - name: 'â¬†ï¸ Upload artifacts PDF â¬†ï¸'
        uses: actions/upload-artifact@v6
        with:
          name: 'pdf'
          path: '${{ inputs.working_directory_for_latex }}/${{ inputs.file_name }}.pdf'

      - name: 'ğŸ”„ Prepare HTML artifact ğŸ”„'
        if: ${{ inputs.enable_pandoc }}
        run: |
          mkdir -p html/sections
          if [ -d "src/sections/images" ]; then
            cp -r src/sections/images html/sections/
          fi
          cp ${{ inputs.working_directory_for_latex }}/index.html html/

      - name: 'â¬†ï¸ Upload artifacts HTML â¬†ï¸'
        if: ${{ inputs.enable_pandoc }}
        uses: actions/upload-artifact@v6
        with:
          name: 'html'
          path: html
