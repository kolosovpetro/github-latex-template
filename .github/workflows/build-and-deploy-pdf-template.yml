name: 'Deploy'
on:
  workflow_call:
    inputs:
      file_name:
        description: 'LaTeX root file name without extension, example: MyTeXFile'
        required: true
        type: string

      runs_on:
        description: 'Agent image'
        required: true
        type: string

      workflow_name:
        description: 'Workflow name'
        required: true
        type: string

      build_assets_path:
        description: 'Build assets path'
        required: true
        type: string

      working_directory_for_latex:
        description: 'Working directory for LaTeX'
        required: true
        type: string

      enable_patch_version:
        description: 'Enable to patch version.tex file'
        required: true
        default: true
        type: boolean

      enable_pandoc:
        description: 'Enable pandoc build for HTML'
        required: false
        default: false
        type: boolean

      enable_html_deploy:
        description: 'Enable HTML deploy to GitHub pages'
        required: false
        default: false
        type: boolean

      html_deploy_path:
        description: 'Path for HTML deploy. Example: kolosovpetro.github.io/math/${html_deploy_path}.'
        required: false
        default: 'test'
        type: string


env:
  TOKEN: ${{ secrets.GH_ACCESS_TOKEN }}
  USERNAME: "kolosovpetro"
  EMAIL: "kolosovp94@gmail.com"
  MESSAGE: "CICD deploy of ${{ inputs.file_name }} PDF document"

jobs:
  build:
    uses: ./.github/workflows/build-pdf-template.yml
    with:
      file_name: '${{ inputs.file_name }}'
      enable_patch_version: true
      enable_pandoc: ${{ inputs.enable_pandoc }}
      runs_on: 'ubuntu-latest'
      workflow_name: 'Build PDF'
      build_assets_path: '${{ inputs.build_assets_path }}'
      working_directory_for_latex: 'src'
  
  deploy:
    needs: build
    runs-on: ${{ inputs.runs_on }}
    name: ${{ inputs.workflow_name }}

    steps:
      - name: 'â¬‡ï¸ Download PDF artifact â¬‡ï¸'
        uses: actions/download-artifact@v6
        with:
          name: 'pdf'
          path: downloaded/pdf

      - name: 'ğŸ” Validate PDF artifact ğŸ”'
        run: |
          ls -lsa downloaded/pdf/*.pdf

      - name: 'â¬‡ï¸ Download HTML artifact â¬‡ï¸'
        if: ${{ inputs.enable_pandoc }}
        uses: actions/download-artifact@v6
        with:
          name: 'html'
          path: downloaded/html

      - name: 'ğŸ” Validate HTML artifact'
        run: |
          ls -lsa downloaded/html
      
      - name: 'ğŸ“€ Clone repository ğŸ“€'
        run: |
          git clone https://${{ env.TOKEN }}@github.com/kolosovpetro/kolosovpetro.github.io.git ~/kolosovpetro.github.io

      - name: 'ğŸ“€ Deploy PDF ğŸ“€'
        run: cp downloaded/pdf/*.pdf ~/kolosovpetro.github.io/pdf

      - name: 'ğŸ“€ Deploy HTML ğŸ“€'
        if: ${{ inputs.enable_html_deploy }}
        run: |
          mkdir -p ~/kolosovpetro.github.io/${{ inputs.html_deploy_path }}
          cp -r downloaded/html/* ~/kolosovpetro.github.io/${{ inputs.html_deploy_path }}

      - name: 'â‡ï¸ Commit changes â‡ï¸'
        run: |
          cd ~/kolosovpetro.github.io
          git config --global user.name "${{ env.USERNAME }}"
          git config --global user.email "${{ env.EMAIL }}"
          git add .
          git commit -m "${{ env.MESSAGE }}"
          git push
